#!/bin/bash

# VioletVault Rebase Script
# Updated for new workflow: feature branches â†’ develop â†’ main

set -e

CURRENT_BRANCH=$(git branch --show-current)

echo "ğŸŒ¿ VioletVault Rebase Script"
echo "============================="
echo "ğŸ” Current branch: $CURRENT_BRANCH"

# Determine target branch based on current branch
if [[ "$CURRENT_BRANCH" == "develop" ]]; then
  TARGET_BRANCH="main"
  echo "ğŸ’¡ Rebasing develop branch onto main"
elif [[ "$CURRENT_BRANCH" == "main" ]]; then
  echo "âŒ Cannot rebase main branch onto itself"
  exit 1
else
  TARGET_BRANCH="develop" 
  echo "ğŸ’¡ Rebasing feature branch onto develop"
fi

read -p "â“ Do you want to rebase this branch onto $TARGET_BRANCH? (y/n) " CONFIRM

if [[ "$CONFIRM" != "y" ]]; then
  echo "âŒ Rebase canceled."
  exit 0
fi

echo "ğŸ§¹ Running Prettier and ESLint fix..."
npm run format
npm run lint:fix

echo "ğŸ“¦ Checking for newly modified files (e.g. .vscode/tasks.json)..."
if ! git diff --quiet; then
  git add .
  git commit -m "chore: commit updated dev environment or remaining changes"
fi

echo "ğŸ”— Staging changes..."
if ! git diff --quiet; then
  git add .
  git commit -m "chore: apply Prettier/ESLint and local edits"
else
  echo "â†’ No changes to commit after Prettier/ESLint."
fi

echo "ğŸ“¥ Fetching latest $TARGET_BRANCH..."
git fetch origin $TARGET_BRANCH

echo "ğŸ§¼ Final check for unstaged changes before rebase..."
if ! git diff --quiet; then
  echo "âŒ Unstaged changes detected. Please commit or stash them manually."
  git status
  exit 1
fi

echo "ğŸ§¬ Rebasing $CURRENT_BRANCH onto origin/$TARGET_BRANCH..."
git rebase origin/$TARGET_BRANCH

echo "ğŸ” Checking for local commits on $CURRENT_BRANCH..."
LOCAL_COMMITS=$(git log origin/$CURRENT_BRANCH..HEAD --oneline)

if [ -z "$LOCAL_COMMITS" ]; then
  echo "âœ… No local commits to squash. Skipping."
else
  echo "ğŸ“ Found local commits:"
  echo "$LOCAL_COMMITS"

  echo "ğŸ” Validating Conventional Commit messages..."
  INVALID_COMMITS=$(git log origin/$CURRENT_BRANCH..HEAD --pretty=format:"%h %s" | grep -vE "^[0-9a-f]{7,} (feat|fix|chore|docs|style|refactor|perf|test)(\(.+\))?: .+" || true)

  if [ -n "$INVALID_COMMITS" ]; then
    echo "âŒ Some commits do not follow Conventional Commits:"
    echo ""
    echo "$INVALID_COMMITS"
    echo ""
    echo "ğŸ’¡ Please reword these commits manually using:"
    echo "   git rebase -i origin/$CURRENT_BRANCH"
    echo "ğŸ›‘ Aborting script to let you fix the commit messages."
    exit 1
  fi

  echo "ğŸ”§ Squashing local commits..."
  LAST_MESSAGE=$(git log -1 --pretty=%B)
  git reset --soft origin/$CURRENT_BRANCH
  git commit -m "$LAST_MESSAGE"
  echo "âœ… Commits squashed."
fi

echo "ğŸš€ Pushing branch with --force-with-lease..."
git push --force-with-lease
echo "âœ… Branch pushed successfully."
