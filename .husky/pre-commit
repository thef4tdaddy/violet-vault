set -u

# Get staged files (added/changed/moved)
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"

# Nothing staged? exit successfully
if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No files staged for commit, skipping hooks"
  exit 0
fi

# Run Prettier on staged files that it manages
FORMAT_FILES="$(printf '%s\n' "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json|css|md)$' || true)"
if [ -n "$FORMAT_FILES" ]; then
  echo "ðŸŽ¨ Running Prettier on staged files..."
  printf '%s\n' "$FORMAT_FILES" | xargs -r npx prettier --config ./configs/linting/prettier.config.js --write
  printf '%s\n' "$FORMAT_FILES" | xargs -r git add
  # Refresh staged file list after formatting
  STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"
fi

# Nothing staged after formatting? exit successfully
if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No files staged for commit after formatting, skipping hooks"
  exit 0
fi

# If all staged files are docs/config only, skip linting
# (matches: docs/, any .md, README.md, CHANGELOG.md, LICENSE, .husky/)
DOCS_ONLY_PATTERNS='^\(docs/\|README\.md$\|.*\.md$\|CHANGELOG\.md$\|LICENSE$\|\.husky/\)'
NON_DOCS="$(printf '%s\n' "$STAGED_FILES" | grep -Ev "$DOCS_ONLY_PATTERNS" || true)"

if [ -z "$NON_DOCS" ]; then
  echo "ðŸ“ Documentation-only commit detected, skipping ESLint"
  printf 'ðŸ“„ Files:\n%s\n' "$STAGED_FILES"
  exit 0
fi

# Collect JS/TS files to lint (excluding config files and configs/ directory)
CODE_FILES="$(printf '%s\n' "$NON_DOCS" | grep -E '\.(js|jsx|ts|tsx)$' | grep -Ev '(\.config\.|commitlint|eslint|prettier|configs/)' || true)"

if [ -z "$CODE_FILES" ]; then
  echo "âœ… No JS/TS source files staged for commit, skipping ESLint"
  exit 0
fi

echo "ðŸ” Running ESLint on staged files..."
printf 'Linting:\n%s\n' "$CODE_FILES"

# Run ESLint on just the staged JS/TS files
# (xargs handles spaces/newlines safely)
printf '%s\n' "$CODE_FILES" | xargs npx eslint --config configs/linting/eslint.config.js --max-warnings 500 --
ESLINT_STATUS=$?

if [ $ESLINT_STATUS -ne 0 ]; then
  echo "âŒ ESLint found issues in staged files"
  echo "ðŸ’¡ Run 'npm run lint:fix' to auto-fix issues, then re-stage files"
  exit 1
fi

echo "âœ… ESLint passed for staged files"

echo "ðŸ—ï¸ Running npm run build..."
if ! npm run build; then
  echo "âŒ Build failed. Fix build errors before committing."
  exit 1
fi

echo "ðŸ“Š Running full audit (npm run audit:full)..."
if ! npm run audit:full; then
  echo "âŒ Full audit failed. Check docs/audits for details."
  exit 1
fi

git add docs/audits/audit-report.md >/dev/null 2>&1

echo "âœ… Audit report updated"
exit 0
