
echo "üõ°Ô∏è  VioletVault Pre-commit Quality Gate"

# 1. Run lint-staged for fast, file-level formatting and linting
echo "üîç Running lint-staged..."
npx lint-staged || exit 1

# 2. Check for recent Full Salvo run (last 10 minutes)
# Bypass if only non-core files (infra/docs) are staged
if git diff --cached --name-only | grep -E '^(api/|src/|configs/|scripts/|tsconfig\.json|vitest\.config\.ts)' > /dev/null; then
    SALVO_TOKEN=".git/FULL_SALVO_SUCCESS"
    if [ -f "$SALVO_TOKEN" ]; then
        # Get file modification time
        if [[ "$OSTYPE" == "darwin"* ]]; then
            LAST_RUN=$(stat -f %m "$SALVO_TOKEN")
        else
            LAST_RUN=$(stat -c %Y "$SALVO_TOKEN" 2>/dev/null || date +%s)
        fi
        
        NOW=$(date +%s)
        DIFF=$((NOW - LAST_RUN))
        
        if [ $DIFF -gt 600 ]; then
            echo "‚ùå Full Salvo outdated (last run: ${DIFF}s ago)."
            echo "Please run './scripts/full_salvo.sh' to verify project integrity before committing."
            exit 1
        else
            echo "‚úÖ Full Salvo verified (${DIFF}s ago)."
        fi
    else
        echo "‚ùå Full Salvo never run."
        echo "Please run './scripts/full_salvo.sh' to verify project integrity before committing."
        exit 1
    fi
else
    echo "‚ÑπÔ∏è  Non-core changes detected (infra/docs). Bypassing Full Salvo requirement."
fi



# 4. Auto-bump beta version
 # echo "üîñ Auto-bumping beta version..."
# npm version prerelease --preid=beta --no-git-tag-version
git add package.json

echo "‚úÖ Quality checks passed! Proceeding with commit."
