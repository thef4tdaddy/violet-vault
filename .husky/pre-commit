set -u

# Get staged files (added/changed/moved)
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"

# Nothing staged? exit successfully
if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No files staged for commit, skipping hooks"
  exit 0
fi

# Run Prettier on staged files that it manages
FORMAT_FILES="$(printf '%s\n' "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json|css|md)$' || true)"
if [ -n "$FORMAT_FILES" ]; then
  echo "ðŸŽ¨ Running Prettier on staged files..."
  printf '%s\n' "$FORMAT_FILES" | xargs -r npx prettier --config ./configs/linting/prettier.config.js --write
  printf '%s\n' "$FORMAT_FILES" | xargs -r git add
  # Refresh staged file list after formatting
  STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"
fi

# Nothing staged after formatting? exit successfully
if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No files staged for commit after formatting, skipping hooks"
  exit 0
fi

# If all staged files are docs/config only, skip linting
# (matches: docs/, any .md, README.md, CHANGELOG.md, LICENSE, .husky/)
DOCS_ONLY_PATTERNS='^\(docs/\|README\.md$\|.*\.md$\|CHANGELOG\.md$\|LICENSE$\|\.husky/\)'
NON_DOCS="$(printf '%s\n' "$STAGED_FILES" | grep -Ev "$DOCS_ONLY_PATTERNS" || true)"

if [ -z "$NON_DOCS" ]; then
  echo "ðŸ“ Documentation-only commit detected, skipping ESLint"
  printf 'ðŸ“„ Files:\n%s\n' "$STAGED_FILES"
  exit 0
fi

# Collect JS/TS files to lint (excluding config files and configs/ directory)
CODE_FILES="$(printf '%s\n' "$NON_DOCS" | grep -E '\.(js|jsx|ts|tsx)$' | grep -Ev '(\.config\.|commitlint|eslint|prettier|configs/)' || true)"

if [ -z "$CODE_FILES" ]; then
  echo "âœ… No JS/TS source files staged for commit, skipping ESLint"
  exit 0
fi

echo "ðŸ” Running ESLint on staged files..."
printf 'Linting:\n%s\n' "$CODE_FILES"

# Run ESLint on just the staged JS/TS files
# (xargs handles spaces/newlines safely)
# Zero tolerance: no warnings allowed (0/0/0 achieved)
printf '%s\n' "$CODE_FILES" | xargs npx eslint --config configs/linting/eslint.config.js --max-warnings 0 --
ESLINT_STATUS=$?

if [ $ESLINT_STATUS -ne 0 ]; then
  echo "âŒ ESLint found issues in staged files"
  echo "ðŸ’¡ Run 'npm run lint:fix' to auto-fix issues, then re-stage files"
  exit 1
fi

echo "âœ… ESLint passed for staged files"

# Check if any TS/TSX files are staged
TS_FILES="$(printf '%s\n' "$CODE_FILES" | grep -E '\.(ts|tsx)$' || true)"

if [ -n "$TS_FILES" ]; then
  echo "ðŸ” Running TypeScript normal mode check on staged files..."
  # Run normal mode check (checks entire project but we only fail if errors exceed threshold)
  # This is necessary because TypeScript's type system requires project-wide analysis
  # Use tsconfig.normal.json which extends tsconfig.json but sets strict: false
  TYPECHECK_OUTPUT=$(npx tsc --project tsconfig.normal.json --noEmit 2>&1 || true)
  ERROR_COUNT=$(echo "$TYPECHECK_OUTPUT" | { grep "error TS" || true; } | wc -l | tr -d ' ')
  # Pre-commit threshold: Zero tolerance - no normal mode errors allowed
  # Status: 0/0/0 achieved (ESLint/TS normal/TS strict)
  ERROR_THRESHOLD=0

  if [ "$ERROR_COUNT" -gt "$ERROR_THRESHOLD" ]; then
    echo "âŒ TypeScript normal mode errors detected! ($ERROR_COUNT > $ERROR_THRESHOLD)"
    echo "ðŸ“Š Current errors: $ERROR_COUNT"
    echo "ðŸ“ˆ Threshold: $ERROR_THRESHOLD (zero tolerance)"
    echo "ðŸ”§ Run: npm run typecheck to see all errors"
    echo "ðŸ’¡ Fix all normal mode errors before committing"
    exit 1
  fi

  echo "âœ… TypeScript normal mode check passed! ($ERROR_COUNT errors)"

  echo "ðŸ” Running TypeScript strict mode check on staged files..."
  # Run strict mode check (checks entire project but we only fail if errors exceed threshold)
  # This is necessary because TypeScript's type system requires project-wide analysis
  # Strict mode is now enabled in tsconfig.json, so --strict is redundant but kept for clarity
  TYPECHECK_OUTPUT=$(npx tsc --noEmit --strict --allowJs false 2>&1 || true)
  ERROR_COUNT=$(echo "$TYPECHECK_OUTPUT" | { grep "error TS" || true; } | wc -l | tr -d ' ')
  # Pre-commit threshold: Zero tolerance - no strict mode errors allowed
  # Status: 0/0/0 achieved (ESLint/TS normal/TS strict)
  ERROR_THRESHOLD=0

  if [ "$ERROR_COUNT" -gt "$ERROR_THRESHOLD" ]; then
    echo "âŒ TypeScript strict mode errors detected! ($ERROR_COUNT > $ERROR_THRESHOLD)"
    echo "ðŸ“Š Current errors: $ERROR_COUNT"
    echo "ðŸ“ˆ Threshold: $ERROR_THRESHOLD (zero tolerance)"
    echo "ðŸ”§ Run: npm run typecheck:strict to see all errors"
    echo "ðŸ’¡ Fix all strict mode errors before committing"
    exit 1
  fi

  echo "âœ… TypeScript strict mode check passed! ($ERROR_COUNT errors)"
else
  echo "âœ… No TypeScript files staged, skipping TypeScript checks"
fi

echo "ðŸ—ï¸ Running npm run build..."
if ! npm run build; then
  echo "âŒ Build failed. Fix build errors before committing."
  exit 1
fi

echo "ðŸ“Š Running full audit (npm run audit:full)..."
if ! npm run audit:full; then
  echo "âŒ Full audit failed. Check docs/audits for details."
  exit 1
fi

git add docs/audits/audit-report.md >/dev/null 2>&1

echo "âœ… Audit report updated"
exit 0
