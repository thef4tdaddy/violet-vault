<!doctype html>
<html>
  <head>
    <title>VioletVault Sync Debug Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      input,
      button {
        padding: 8px;
        margin: 5px;
      }
      .result {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        font-family: monospace;
      }
      .error {
        background: #ffebee;
        color: #c62828;
      }
      .success {
        background: #e8f5e8;
        color: #2e7d32;
      }
      .warning {
        background: #fff3e0;
        color: #ef6c00;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç VioletVault Sync Debug Tool</h1>
      <p>
        This tool helps debug sync issues by showing exactly what budgetId and encryption keys are
        generated from passwords.
      </p>

      <div class="section">
        <h3>Password to BudgetId Converter</h3>
        <input
          type="password"
          id="password"
          placeholder="Enter your password"
          style="width: 300px"
        />
        <button onclick="generateIds()">Generate BudgetId</button>

        <div id="results"></div>
      </div>

      <div class="section">
        <h3>Compare Multiple Passwords</h3>
        <p>Test if slightly different passwords generate the same budgetId:</p>
        <textarea
          id="passwords"
          rows="5"
          cols="50"
          placeholder="Enter one password per line to compare:
mypassword
mypassword 
MyPassword
mypassword123"
        ></textarea>
        <br />
        <button onclick="comparePasswords()">Compare All</button>

        <div id="comparison"></div>
      </div>

      <div class="section">
        <h3>Firebase Connection Test</h3>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <div id="firebaseTest"></div>
      </div>

      <div class="section">
        <h3>Live Document Check</h3>
        <p>Check if a specific budgetId has data in Firebase:</p>
        <input
          type="text"
          id="budgetIdCheck"
          placeholder="Enter budgetId (e.g., budget_abc123)"
          style="width: 300px"
        />
        <button onclick="checkDocument()">Check Document</button>
        <div id="documentCheck"></div>
      </div>
    </div>

    <script type="module">
      // Import the encryption utilities (you'll need to adjust this path)
      const encryptionUtils = {
        generateBudgetId(masterPassword) {
          let hash = 0;
          for (let i = 0; i < masterPassword.length; i++) {
            const char = masterPassword.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash = hash & hash;
          }
          return `budget_${Math.abs(hash).toString(16)}`;
        },

        async generateKey(password) {
          const encoder = new TextEncoder();
          const keyMaterial = await crypto.subtle.importKey(
            "raw",
            encoder.encode(password),
            { name: "PBKDF2" },
            false,
            ["deriveBits", "deriveKey"]
          );

          // Generate deterministic salt from password to ensure same password = same key
          const passwordBytes = encoder.encode(password + "VioletVault_Salt");
          const saltHash = await crypto.subtle.digest("SHA-256", passwordBytes);
          const salt = new Uint8Array(saltHash.slice(0, 16));

          const key = await crypto.subtle.deriveKey(
            {
              name: "PBKDF2",
              salt: salt,
              iterations: 100000,
              hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            true,
            ["encrypt", "decrypt"]
          );

          return { key, salt };
        },
      };

      window.generateIds = async function () {
        const password = document.getElementById("password").value;
        const resultsDiv = document.getElementById("results");

        if (!password) {
          resultsDiv.innerHTML = '<div class="error">Please enter a password</div>';
          return;
        }

        try {
          const budgetId = encryptionUtils.generateBudgetId(password);
          const keyData = await encryptionUtils.generateKey(password);

          resultsDiv.innerHTML = `
                    <div class="result success">
                        <strong>Password:</strong> "${password}"<br>
                        <strong>Length:</strong> ${password.length} characters<br>
                        <strong>BudgetId:</strong> ${budgetId}<br>
                        <strong>Salt (first 8 bytes):</strong> ${Array.from(
                          keyData.salt.slice(0, 8)
                        )
                          .map((b) => b.toString(16).padStart(2, "0"))
                          .join(" ")}<br>
                        <strong>Password Hash (for debugging):</strong> ${password
                          .split("")
                          .map((c) => c.charCodeAt(0))
                          .join(", ")}
                    </div>
                `;
        } catch (error) {
          resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        }
      };

      window.comparePasswords = async function () {
        const passwords = document
          .getElementById("passwords")
          .value.split("\n")
          .filter((p) => p.trim());
        const comparisonDiv = document.getElementById("comparison");

        if (passwords.length === 0) {
          comparisonDiv.innerHTML = '<div class="error">Please enter at least one password</div>';
          return;
        }

        let html = "<h4>Comparison Results:</h4>";
        const budgetIds = new Map();

        for (const password of passwords) {
          if (password.trim()) {
            const budgetId = encryptionUtils.generateBudgetId(password);
            const display = password.replace(/\s/g, "‚ê£"); // Show spaces

            if (budgetIds.has(budgetId)) {
              budgetIds.get(budgetId).push(display);
            } else {
              budgetIds.set(budgetId, [display]);
            }

            html += `
                        <div class="result">
                            <strong>Password:</strong> "${display}" (${password.length} chars)<br>
                            <strong>BudgetId:</strong> ${budgetId}
                        </div>
                    `;
          }
        }

        // Show conflicts
        html += "<h4>Conflicts Analysis:</h4>";
        let hasConflicts = false;

        for (const [budgetId, passwordList] of budgetIds) {
          if (passwordList.length > 1) {
            hasConflicts = true;
            html += `
                        <div class="result success">
                            <strong>‚úÖ Same BudgetId (${budgetId}):</strong><br>
                            ${passwordList.map((p) => `"${p}"`).join("<br>")}
                        </div>
                    `;
          }
        }

        if (!hasConflicts && budgetIds.size > 1) {
          html +=
            '<div class="result warning">‚ö†Ô∏è All passwords generate different BudgetIds - they won\'t sync with each other!</div>';
        } else if (!hasConflicts && budgetIds.size === 1) {
          html +=
            '<div class="result success">‚úÖ All passwords generate the same BudgetId - they will sync together!</div>';
        }

        comparisonDiv.innerHTML = html;
      };

      window.testFirebaseConnection = async function () {
        const testDiv = document.getElementById("firebaseTest");
        testDiv.innerHTML = '<div class="result">Testing Firebase connection...</div>';

        try {
          // Test connection to the actual project
          const projectId = "violetvault-3a71f";
          const response = await fetch(
            `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/test/test`
          );

          if (response.status === 404) {
            testDiv.innerHTML =
              '<div class="result success">‚úÖ Firebase is reachable (404 expected for test endpoint)</div>';
          } else if (response.status === 403) {
            testDiv.innerHTML =
              '<div class="result warning">‚ö†Ô∏è Firebase connection works but access denied (403) - this is normal without auth</div>';
          } else {
            testDiv.innerHTML = `<div class="result warning">‚ö†Ô∏è Firebase responded with status: ${response.status}</div>`;
          }
        } catch (error) {
          if (
            error.message.includes("blocked") ||
            error.message.includes("ERR_BLOCKED_BY_CLIENT")
          ) {
            testDiv.innerHTML =
              '<div class="result error">‚ùå Firebase requests are being blocked by ad blocker or extension</div>';
          } else {
            testDiv.innerHTML = `<div class="result error">‚ùå Firebase connection error: ${error.message}</div>`;
          }
        }
      };

      window.checkDocument = async function () {
        const budgetId = document.getElementById("budgetIdCheck").value.trim();
        const checkDiv = document.getElementById("documentCheck");

        if (!budgetId) {
          checkDiv.innerHTML = '<div class="error">Please enter a budgetId</div>';
          return;
        }

        checkDiv.innerHTML = '<div class="result">Checking document...</div>';

        try {
          const projectId = "violetvault-3a71f";
          const apiKey = "***REMOVED***";

          // Use Firebase REST API to check document
          const response = await fetch(
            `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/budgets/${budgetId}?key=${apiKey}`
          );

          if (response.ok) {
            const doc = await response.json();
            const hasEncryptedData = !!(doc.fields && doc.fields.encryptedData);
            const lastUpdated = doc.fields?.lastUpdated?.timestampValue;
            const keys = doc.fields ? Object.keys(doc.fields) : [];

            checkDiv.innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ Document exists!</strong><br>
                            <strong>BudgetId:</strong> ${budgetId}<br>
                            <strong>Has encrypted data:</strong> ${hasEncryptedData}<br>
                            <strong>Last updated:</strong> ${lastUpdated || "Unknown"}<br>
                            <strong>Fields in document:</strong> ${keys.join(", ")}<br>
                            <br>
                            <details>
                                <summary>Raw document structure:</summary>
                                <pre>${JSON.stringify(doc, null, 2)}</pre>
                            </details>
                        </div>
                    `;
          } else if (response.status === 404) {
            checkDiv.innerHTML = `
                        <div class="result warning">
                            <strong>‚ö†Ô∏è Document not found</strong><br>
                            BudgetId: ${budgetId}<br>
                            This means either:<br>
                            ‚Ä¢ No data has been saved with this password yet<br>
                            ‚Ä¢ Different password is being used on the device that "saved" data<br>
                            ‚Ä¢ Data was saved to a different Firebase project
                        </div>
                    `;
          } else {
            checkDiv.innerHTML = `<div class="result error">‚ùå Error: HTTP ${response.status} - ${response.statusText}</div>`;
          }
        } catch (error) {
          checkDiv.innerHTML = `<div class="result error">‚ùå Error checking document: ${error.message}</div>`;
        }
      };
    </script>
  </body>
</html>
