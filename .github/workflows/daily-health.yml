name: Daily Health Check

on:
  schedule:
    # Run every day at 09:00 UTC
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      context:
        description: "Execution Context"
        required: true
        default: "alpha"
        type: choice
        options:
          - alpha
          - beta
          - production

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # TODO (v2.0 Beta): Update 'alpha' to target 'develop' once the hybrid rewrite reaches beta stability.
          # TODO (v2.0 Live): Revert to 'github.ref' or explicit 'main' once v2.0 is fully merged to production.
          ref: ${{ (inputs.context || 'alpha') == 'alpha' && 'feat/polygot-rewrite' || (inputs.context == 'beta' && 'develop' || github.ref) }}

      # --- Setup Environments ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Setup Go
        # TODO (v2.0): Once polyglot is standard across all branches, this conditional can be removed.
        if: hashFiles('api/go.sum') != ''
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.1"
          cache-dependency-path: api/go.sum

      - name: Setup Python
        # TODO (v2.0): Once polyglot is standard across all branches, this conditional can be removed.
        if: hashFiles('requirements.txt', 'pyproject.toml', 'api/requirements.txt') != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # --- Install Dependencies ---
      - name: Install Node Deps
        run: npm ci

      - name: Install Python Deps
        run: |
          if [ -f "requirements.txt" ]; then
            python -m venv .venv
            source .venv/bin/activate
            pip install -r requirements.txt
            pip install pytest pytest-cov
          elif [ -f "pyproject.toml" ]; then
             python -m venv .venv
             source .venv/bin/activate
             pip install .
             pip install pytest pytest-cov
          else
            python -m venv .venv
            source .venv/bin/activate
            pip install pytest pytest-cov
          fi

      - name: Install Go Deps
        if: hashFiles('api/go.mod') != ''
        run: |
          cd api
          go mod download
          cd ..

      # --- Build ---
      - name: Build Frontend
        id: build
        run: npm run build

      # --- Tests & Coverage ---

      # 1. Frontend (Vitest)
      - name: Frontend Tests
        id: test_frontend
        continue-on-error: true
        run: |
          npm run test:coverage -- --coverage.reporter=text --coverage.reporter=json-summary > frontend-test.txt 2>&1
          exit_code=$?
          cat frontend-test.txt
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then echo "status=success" >> $GITHUB_OUTPUT; else echo "status=failure" >> $GITHUB_OUTPUT; fi

      # 2. Go Backend
      - name: Go Tests
        id: test_go
        if: hashFiles('api/**/*.go') != ''
        continue-on-error: true
        run: |
          cd api
          # Go 1.23 coverage
          go test ./... -coverprofile=coverage.out > ../go-test.txt 2>&1
          exit_code=$?
          cd ..
          cat go-test.txt
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then echo "status=success" >> $GITHUB_OUTPUT; else echo "status=failure" >> $GITHUB_OUTPUT; fi

      # 3. Python Backend
      - name: Python Tests
        id: test_python
        if: hashFiles('api/**/*.py') != ''
        continue-on-error: true
        run: |
          source .venv/bin/activate
          cd api
          # Run pytest with coverage
          pytest --cov=. --cov-report=term-missing > ../python-test.txt 2>&1
          exit_code=$?
          cd ..
          cat python-test.txt
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then echo "status=success" >> $GITHUB_OUTPUT; else echo "status=failure" >> $GITHUB_OUTPUT; fi

      # --- Reporting ---
      - name: Health Report & Tasks
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Gather Statuses
            const contextName = '${{ inputs.context || 'scheduled' }}';
            const buildStatus = '${{ steps.build.outcome }}';
            const feStatus = '${{ steps.test_frontend.outputs.status }}' || 'skipped';
            const goStatus = '${{ steps.test_go.outputs.status }}' || 'skipped';
            const pyStatus = '${{ steps.test_python.outputs.status }}' || 'skipped';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const isHealthy = buildStatus === 'success' && 
                             (feStatus !== 'failure') && 
                             (goStatus !== 'failure') && 
                             (pyStatus !== 'failure');
            const emoji = isHealthy ? '✅' : '❌';
            const dateStr = new Date().toISOString().split('T')[0];
            const title = `Daily Health: ${dateStr} - ${emoji}`;

            let body = `## ${emoji} Daily Health Check: ${dateStr}\n\n`;
            body += `**Context**: ${contextName}\n`;
            body += `**Workflow Run**: [View Logs](${runUrl})\n\n`;

            body += `### Status Breakdown\n`;
            body += `- **Build**: ${buildStatus === 'success' ? '✅ Pass' : '❌ FAIL'}\n`;
            body += `- **Frontend Tests**: ${feStatus === 'success' ? '✅ Pass' : (feStatus === 'failure' ? '❌ FAIL' : '⚪ Skipped')}\n`;
            body += `- **Go Tests**: ${goStatus === 'success' ? '✅ Pass' : (goStatus === 'failure' ? '❌ FAIL' : '⚪ Skipped')}\n`;
            body += `- **Python Tests**: ${pyStatus === 'success' ? '✅ Pass' : (pyStatus === 'failure' ? '❌ FAIL' : '⚪ Skipped')}\n`;

            // Frontend Coverage Parsing (JSON)
            if (fs.existsSync('coverage/coverage-summary.json')) {
               try {
                   const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                   const total = coverage.total.lines.pct;
                   body += `\n### Frontend Coverage\n`;
                   body += `- **Total**: ${total}%\n`;
                   
                   // Find worst offenders
                   const lowCovFiles = [];
                   for (const [filepath, metrics] of Object.entries(coverage)) {
                       if (filepath === 'total') continue;
                       if (filepath.includes('config') || filepath.includes('.d.ts')) continue;
                       
                       if (metrics.lines.pct < 80) {
                           lowCovFiles.push({ file: filepath, pct: metrics.lines.pct });
                       }
                   }
                   
                   lowCovFiles.sort((a, b) => a.pct - b.pct);
                   
                   if (lowCovFiles.length > 0) {
                       body += `\n**Lowest Coverage Files:**\n`;
                       for (const item of lowCovFiles.slice(0, 5)) {
                           body += `- \`${item.file}\`: ${item.pct}%\n`;
                       }

                       // Create Tasks for worst 3
                       const candidates = lowCovFiles.slice(0, 3);
                       for (const item of candidates) {
                           const parts = item.file.split('/');
                           const basename = parts[parts.length - 1];
                           const issueTitle = `test(${basename}): Improve coverage for ${basename}`;
                           
                           const existing = await github.rest.search.issuesAndPullRequests({
                               q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open "Improve coverage for ${basename}"`
                           });
                           
                           if (existing.data.total_count === 0) {
                               await github.rest.issues.create({
                                   owner: context.repo.owner,
                                   repo: context.repo.repo,
                                   title: issueTitle,
                                   body: `Automated Coverage Task\n\nFile: \`${item.file}\`\nCurrent Coverage: **${item.pct}%**\n\nPlease add tests.`,
                                   labels: ['coverage-gap', 'help-wanted', 'automated']
                               });
                           }
                       }
                   }
               } catch (e) {
                   console.error("Error parsing FE coverage", e);
               }
            }

            // TODO: Implement Granular Coverage Reporting for Go & Python
            // Strategy: Once Frontend coverage > 80%, implement JSON parsing for:
            // - Go: parse `coverage.out` (convert to summary format)
            // - Python: parse `coverage.json` from pytest-cov
            // Currently: Full artifacts are uploaded for manual inspection.

            body += `\n---\n*VioletVault Health Bot*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-health']
            });

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-logs
          path: |
            coverage/
            frontend-test.txt
            go-test.txt
            python-test.txt
            api/coverage.out
          retention-days: 7
