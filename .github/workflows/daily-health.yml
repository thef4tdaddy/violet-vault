name: Daily Health Check

on:
  schedule:
    # Run every day at 09:00 UTC
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      context:
        description: "Execution Context"
        required: true
        default: "alpha"
        type: choice
        options:
          - alpha
          - beta
          - production

permissions:
  contents: write
  issues: write

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      # --- Setup Environments ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Setup Go
        if: hashFiles('api/go.sum') != ''
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.1"
          cache-dependency-path: api/go.sum

      - name: Setup Python
        if: hashFiles('requirements.txt', 'pyproject.toml', 'api/requirements.txt') != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # --- Install Dependencies ---
      - name: Install Node Deps
        run: npm ci

      - name: Security Audit
        continue-on-error: true
        id: security_audit
        run: |
          npm audit --audit-level=high > npm-audit.txt 2>&1 || true
          VULNS=$(grep -c "high" npm-audit.txt || echo "0")
          echo "vulns=$VULNS" >> $GITHUB_OUTPUT

      - name: Install Python Deps
        run: |
          python -m venv .venv
          source .venv/bin/activate
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          if [ -f "pyproject.toml" ]; then
            pip install .
          fi
          if [ -f "api/requirements.txt" ]; then
            pip install -r api/requirements.txt
          fi
          pip install pytest pytest-cov
          cd ..

      - name: Install Go Deps
        if: hashFiles('api/go.mod') != ''
        run: |
          cd api
          go mod download
          cd ..

      # --- Housekeeping ---
      - name: Stale Branch Cleanup
        id: cleanup
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üßπ Housekeeping: Stale Branch Cleanup"

          # Protected: main, develop, feat/*, archive/*, dependabot/*, lighthouse-reports
          PROTECTED_REGEX="^(main|develop|feat/|archive/|dependabot/|lighthouse-reports)"
          CUTOFF_DATE=$(date -d "72 hours ago" +%s)

          DELETED_BRANCHES=""

          # Get all remote branches
          ALL_BRANCHES=$(git branch -r | sed 's/origin\///' | tr -d ' ' | grep -v "HEAD")

          for BRANCH in $ALL_BRANCHES; do
            if [[ $BRANCH =~ $PROTECTED_REGEX ]]; then
              continue
            fi
            
            LAST_COMMIT_DATE=$(git log -1 --format=%ct "origin/$BRANCH" 2>/dev/null || echo "0")
            if [ "$LAST_COMMIT_DATE" -lt "$CUTOFF_DATE" ] && [ "$LAST_COMMIT_DATE" -ne "0" ]; then
              echo "üóëÔ∏è Deleting stale branch: $BRANCH"
              git push origin --delete "$BRANCH" || echo "   ‚ö†Ô∏è Failed to delete $BRANCH"
              DELETED_BRANCHES="$DELETED_BRANCHES $BRANCH"
            fi
          done

          echo "deleted_branches=$DELETED_BRANCHES" >> $GITHUB_OUTPUT

      # --- Build ---
      - name: Build Frontend & Bundle Analysis
        id: build
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: npm run build

      # --- Tests & Coverage ---

      # 1. Frontend (Vitest)
      - name: Frontend Tests
        id: test_frontend
        continue-on-error: true
        run: |
          npm run test:coverage -- --coverage.reporter=text --coverage.reporter=json-summary > frontend-test.txt 2>&1
          exit_code=$?
          cat frontend-test.txt
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then echo "status=success" >> $GITHUB_OUTPUT; else echo "status=failure" >> $GITHUB_OUTPUT; fi

          # Extract coverage percentage if available
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "try { const data=require('./coverage/coverage-summary.json'); console.log(data.total.lines.pct); } catch(e) { console.log('0'); }")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

      # 2. Go Backend
      - name: Go Tests
        id: test_go
        if: hashFiles('api/**/*.go') != ''
        continue-on-error: true
        run: |
          cd api
          # Go 1.23 coverage
          go test ./... -coverprofile=coverage.out > ../go-test.txt 2>&1
          exit_code=$?

          # Extract coverage percentage
          if [ -f "coverage.out" ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            # Generate HTML coverage report
            go tool cover -html=coverage.out -o coverage.html
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

          cd ..
          cat go-test.txt
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then echo "status=success" >> $GITHUB_OUTPUT; else echo "status=failure" >> $GITHUB_OUTPUT; fi

      # 3. Python Backend
      - name: Python Tests
        id: test_python
        if: hashFiles('api/**/*.py') != ''
        continue-on-error: true
        run: |
          source .venv/bin/activate
          cd api
          # Run pytest with coverage (add JSON report)
          # Use python -m pytest to ensure it uses the venv's interpreter
          python -m pytest --cov=. --cov-report=term-missing --cov-report=html --cov-report=json > ../python-test.txt 2>&1
          exit_code=$?

          # Extract coverage percentage
          if [ -f "coverage.json" ]; then
            COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(data['totals']['percent_covered'])" 2>/dev/null || echo "0")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

          cd ..
          cat python-test.txt
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then echo "status=success" >> $GITHUB_OUTPUT; else echo "status=failure" >> $GITHUB_OUTPUT; fi

      # --- Reporting ---
      - name: Health Report & Tasks
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Gather Statuses
            const contextName = '${{ inputs.context || 'scheduled' }}';
            const branchName = context.ref.replace('refs/heads/', '');
            const buildStatus = '${{ steps.build.outcome }}';
            const feStatus = '${{ steps.test_frontend.outputs.status }}' || 'skipped';
            const goStatus = '${{ steps.test_go.outputs.status }}' || 'skipped';
            const pyStatus = '${{ steps.test_python.outputs.status }}' || 'skipped';
            const deletedBranches = '${{ steps.cleanup.outputs.deleted_branches }}'.trim();
            const securityVulns = '${{ steps.security_audit.outputs.vulns }}' || '0';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Get coverage percentages
            const frontendCoverage = parseFloat('${{ steps.test_frontend.outputs.coverage }}') || 0;
            const pythonCoverage = parseFloat('${{ steps.test_python.outputs.coverage }}') || 0;
            const goCoverage = parseFloat('${{ steps.test_go.outputs.coverage }}') || 0;

            const isHealthy = buildStatus === 'success' && 
                             (feStatus !== 'failure') && 
                             (goStatus !== 'failure') && 
                             (pyStatus !== 'failure');
            const emoji = isHealthy ? '‚úÖ' : '‚ùå';
            const dateStr = new Date().toISOString().split('T')[0];
            const title = `Daily Health: ${dateStr} - ${emoji}`;

            let body = `## ${emoji} Daily Health Check: ${dateStr}\n\n`;
            body += `**Branch**: \`${branchName}\`\n`;
            body += `**Workflow Run**: [View Logs](${runUrl})\n\n`;

            // Add Coverage Table
            body += `## üìä System Health Metrics\n\n`;
            body += `| Suite | Coverage | Status |\n`;
            body += `|-------|----------|--------|\n`;
            body += `| Frontend (TypeScript) | ${frontendCoverage.toFixed(1)}% | ${frontendCoverage >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
            body += `| Backend (Python) | ${pythonCoverage.toFixed(1)}% | ${pythonCoverage >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
            body += `| Backend (Go) | ${goCoverage.toFixed(1)}% | ${goCoverage >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
            body += `\n**Coverage & Analysis**: [Codecov Dashboard](https://app.codecov.io/gh/${context.repo.owner}/${context.repo.repo})\n\n`;

            body += `### Infrastructure Status\n`;
            body += `- **Build**: ${buildStatus === 'success' ? '‚úÖ Pass' : '‚ùå FAIL'}\n`;
            body += `- **Security Audit**: ${securityVulns === '0' ? '‚úÖ 0 High Vulns' : `‚ö†Ô∏è ${securityVulns} High Vulns`}\n`;
            body += `- **Stale Branches Removed**: ${deletedBranches ? `üßπ \`${deletedBranches}\`` : '‚úÖ None'}\n\n`;

            // Combined Worst Offenders (across all languages)
            const allOffenders = [];

            // 1. Frontend Offenders
            if (fs.existsSync('coverage/coverage-summary.json')) {
               try {
                   const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                   for (const [filepath, metrics] of Object.entries(coverage)) {
                       if (filepath === 'total' || filepath.includes('config') || filepath.includes('.d.ts')) continue;
                       if (metrics.lines.pct < 80) {
                           allOffenders.push({ file: filepath, pct: metrics.lines.pct, lang: 'TypeScript' });
                       }
                   }
               } catch (e) { console.error("FE parse error", e); }
            }

            // 2. Python Offenders
            if (fs.existsSync('api/coverage.json')) {
               try {
                   const coverage = JSON.parse(fs.readFileSync('api/coverage.json', 'utf8'));
                   for (const [filepath, metrics] of Object.entries(coverage.files)) {
                       const pct = metrics.summary.percent_covered;
                       if (pct < 80) {
                           allOffenders.push({ file: filepath, pct: pct, lang: 'Python' });
                       }
                   }
               } catch (e) { console.error("PY parse error", e); }
            }

            // 3. Go (TODO: Add file-level parsing if needed, currently using summary)

            // Select Top 3 Worst Offenders
            allOffenders.sort((a, b) => a.pct - b.pct);
            const top3 = allOffenders.slice(0, 3);

            if (top3.length > 0) {
                body += `### üìâ Coverage Gap: Top 3 Offenders\n`;
                for (const item of top3) {
                    body += `- \`${item.file}\` (${item.lang}): **${item.pct.toFixed(2)}%**\n`;
                }

                // Issue creation (Only on develop)
                if (branchName === 'develop') {
                    for (const item of top3) {
                        const parts = item.file.split('/');
                        const basename = parts[parts.length - 1];
                        const issueTitle = `test(${basename}): Improve coverage for ${basename}`;
                        
                        const existing = await github.rest.search.issuesAndPullRequests({
                            q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open "${issueTitle}"`
                        });
                        
                        if (existing.data.total_count === 0) {
                            await github.rest.issues.create({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                title: issueTitle,
                                body: `Automated Coverage Task\n\nFile: \`${item.file}\` (${item.lang})\nCurrent Coverage: **${item.pct}%**\n\nPlease add tests.`,
                                labels: ['coverage-gap', 'help-wanted', 'automated']
                            });
                        }
                    }
                }
            }

            body += `\n---\n*VioletVault Sentinel Health Bot*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-health']
            });

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info,./api/coverage.out,./api/coverage.json
          flags: daily-health
          name: daily-health-check
          fail_ci_if_error: false

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-logs
          path: |
            coverage/
            frontend-test.txt
            go-test.txt
            python-test.txt
            api/coverage.out
            api/coverage.html
            api/htmlcov/
            api/coverage.json
          retention-days: 7
