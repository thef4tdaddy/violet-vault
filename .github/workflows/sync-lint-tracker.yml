name: Sync Lint Tracker Workflow

on:
  push:
    branches: [develop]
    paths:
      - '.github/workflows/lint-warnings-tracker.yml'
  
  # Manual trigger option
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check for differences and sync
        run: |
          echo "üîç Checking for differences between develop and main lint tracker workflows..."
          
          # Fetch latest main branch
          git fetch origin main
          
          # Compare lint tracker workflows
          DEVELOP_FILE=".github/workflows/lint-warnings-tracker.yml"
          
          if [ ! -f "$DEVELOP_FILE" ]; then
            echo "‚ùå Lint tracker workflow not found on develop branch"
            exit 1
          fi
          
          # Get main branch version of the file
          git show origin/main:$DEVELOP_FILE > main-lint-tracker.yml 2>/dev/null || echo "# File not found on main" > main-lint-tracker.yml
          
          # Compare files
          if ! diff -q "$DEVELOP_FILE" main-lint-tracker.yml > /dev/null; then
            echo "üîÑ Differences detected! Syncing workflow from develop to main..."
            
            # Checkout main branch
            git checkout main
            git pull origin main
            
            # Copy the file from develop
            git checkout develop -- "$DEVELOP_FILE"
            
            # Check if there are actually changes to commit
            if [ -n "$(git diff --name-only)" ]; then
              echo "üìù Committing updated lint tracker workflow..."
              
              git add "$DEVELOP_FILE"
              git commit -m "$(cat <<'EOF'
sync: update lint-warnings-tracker workflow from develop

This automated sync ensures parity between main and develop branches
for the lint tracking system.

Source: develop branch
Target: main branch
Action: Sync lint-warnings-tracker.yml

ü§ñ Generated with automated sync action

Co-Authored-By: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
EOF
)"
              
              git push origin main
              echo "‚úÖ Successfully synced lint tracker workflow to main branch!"
            else
              echo "‚ÑπÔ∏è No actual changes to commit after checkout"
            fi
          elif [ "${{ inputs.force_sync }}" == "true" ]; then
            echo "üîß Force sync requested - updating main even without detected changes"
            git checkout main
            git pull origin main
            git checkout develop -- "$DEVELOP_FILE"
            
            if [ -n "$(git diff --name-only)" ]; then
              git add "$DEVELOP_FILE"
              git commit -m "sync: force update lint-warnings-tracker workflow from develop"
              git push origin main
              echo "‚úÖ Force sync completed!"
            else
              echo "‚ÑπÔ∏è Files are already identical - no sync needed"
            fi
          else
            echo "‚úÖ Workflows are already in sync - no action needed"
          fi

      - name: Create or update issue comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check if sync was needed/performed
            const wasPerformed = process.env.GITHUB_STEP_SUMMARY?.includes('Successfully synced') || false;
            
            const comment = `üîÑ **Lint Tracker Workflow Sync Status** - ${new Date().toLocaleString('en-US', { 
              timeZone: 'America/Chicago',
              timeZoneName: 'short'
            })}

${wasPerformed ? '‚úÖ **Sync Performed**: Lint tracker workflow updated on main branch from develop' : '‚ÑπÔ∏è **No Sync Needed**: Workflows are already identical between branches'}

**Monitored File**: \`.github/workflows/lint-warnings-tracker.yml\`
**Source Branch**: develop  
**Target Branch**: main
**Trigger**: ${context.eventName === 'workflow_dispatch' ? 'Manual' : 'Automatic (file change detected)'}

This ensures both branches have identical lint tracking capabilities with latest features and bug fixes.`;

            // Post to issue #573 about the action improvements  
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 573,
                body: comment
              });
              console.log('‚úÖ Posted sync status to issue #573');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not post to issue #573:', error.message);
            }