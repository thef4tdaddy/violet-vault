name: Sync Critical Workflows

on:
  push:
    branches: [develop]
    paths:
      - '.github/workflows/lint-warnings-tracker.yml'
      - '.github/workflows/lighthouse-monitoring.yml'
  
  # Manual trigger option
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: false
        type: boolean

jobs:
  sync-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check for differences and sync
        run: |
          echo "üîç Checking for differences between develop and main monitoring workflows..."

          # Fetch latest main branch
          git fetch origin main

          # Define workflows that need to stay in sync
          SYNC_FILES=(
            ".github/workflows/lint-warnings-tracker.yml"
            ".github/workflows/lighthouse-monitoring.yml"
          )

          CHANGES_DETECTED=false
          MISSING_FILES=()

          # Check each file for differences
          for DEVELOP_FILE in "${SYNC_FILES[@]}"; do
            if [ ! -f "$DEVELOP_FILE" ]; then
              echo "‚ùå File not found on develop branch: $DEVELOP_FILE"
              MISSING_FILES+=("$DEVELOP_FILE")
              continue
            fi

            # Get main branch version of the file
            MAIN_FILE="main-$(basename "$DEVELOP_FILE")"
            git show "origin/main:$DEVELOP_FILE" > "$MAIN_FILE" 2>/dev/null || echo "# File not found on main" > "$MAIN_FILE"

            # Compare files
            if ! diff -q "$DEVELOP_FILE" "$MAIN_FILE" > /dev/null; then
              echo "üîÑ Differences detected in: $DEVELOP_FILE"
              CHANGES_DETECTED=true
            else
              echo "‚úÖ Already in sync: $DEVELOP_FILE"
            fi
          done

          # Exit if any files are missing
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "‚ùå Missing files on develop branch: ${MISSING_FILES[*]}"
            exit 1
          fi

          # Sync if changes detected or force sync requested
          if [ "$CHANGES_DETECTED" == "true" ] || [ "${{ inputs.force_sync }}" == "true" ]; then
            echo "üîÑ Syncing workflows from develop to main..."

            # Checkout main branch
            git checkout main
            git pull origin main

            # Copy all sync files from develop
            git checkout develop -- "${SYNC_FILES[@]}"

            # Check if there are actually changes to commit
            if [ -n "$(git diff --cached --name-only)" ]; then
              echo "üìù Committing updated monitoring workflows..."

              git add "${SYNC_FILES[@]}"

              if [ "${{ inputs.force_sync }}" == "true" ]; then
                git commit -m "sync: force update monitoring workflows from develop [automated]

- lighthouse-monitoring.yml
- lint-warnings-tracker.yml"
              else
                git commit -m "sync: update monitoring workflows from develop [automated]

- lighthouse-monitoring.yml
- lint-warnings-tracker.yml"
              fi

              git push origin main
              echo "‚úÖ Successfully synced monitoring workflows to main branch!"
            else
              echo "‚ÑπÔ∏è No actual changes to commit after checkout"
            fi
          else
            echo "‚úÖ All monitoring workflows are already in sync - no action needed"
          fi

      - name: Create or update issue comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check if sync was needed/performed
            const wasPerformed = process.env.GITHUB_STEP_SUMMARY?.includes('Successfully synced') || false;
            
            const syncStatus = wasPerformed ? '‚úÖ Sync Performed' : '‚ÑπÔ∏è No Sync Needed';
            const trigger = context.eventName === 'workflow_dispatch' ? 'Manual' : 'Automatic';
            const comment = 'üîÑ **Monitoring Workflows Sync Status** - ' + new Date().toLocaleString('en-US', { timeZone: 'America/Chicago', timeZoneName: 'short' }) + '\n\n' + syncStatus + ': Monitoring workflows sync completed\n\n**Monitored Files**: \n- `.github/workflows/lint-warnings-tracker.yml`\n- `.github/workflows/lighthouse-monitoring.yml`\n\n**Trigger**: ' + trigger;

            // Post to issue #573 about the action improvements  
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 573,
                body: comment
              });
              console.log('‚úÖ Posted sync status to issue #573');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not post to issue #573:', error.message);
            }