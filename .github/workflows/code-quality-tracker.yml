name: Code Quality Tracker

# Unified workflow to track both ESLint and TypeScript compilation issues
on:
  # Daily tracking at 9 AM UTC
  schedule:
    - cron: "0 9 * * *" # Daily at 9 AM UTC

  # Keep PR checks for validation
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "scripts/**"
      - "*.js"
      - "*.jsx"
      - "*.ts"
      - "*.tsx"

  # Manual trigger option
  workflow_dispatch:

# Prevent duplicate runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  track-code-quality:
    runs-on: ubuntu-latest
    name: Track ESLint and TypeScript Issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'schedule' && 'develop' || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint and capture warnings
        id: eslint
        run: |
          npx eslint --config configs/linting/eslint.config.js . --ext .js,.jsx,.ts,.tsx --format json > eslint-output.json 2>/dev/null || true

          # Count warnings
          WARNINGS=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' eslint-output.json 2>/dev/null || echo 0)
          ERRORS=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' eslint-output.json 2>/dev/null || echo 0)
          TOTAL=$((WARNINGS + ERRORS))

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

          echo "üìä ESLint Results: ${TOTAL} issues (${WARNINGS} warnings, ${ERRORS} errors)"

      - name: Run TypeScript compiler and capture errors
        id: typecheck
        run: |
          npm run typecheck 2>&1 | tee typecheck-output.txt || true

          # Count TypeScript errors
          TS_ERRORS=$(grep -c "error TS" typecheck-output.txt 2>/dev/null || echo 0)

          echo "total=$TS_ERRORS" >> $GITHUB_OUTPUT
          echo "üìä TypeScript Results: ${TS_ERRORS} compilation errors"

      - name: Run TypeScript strict mode check and capture errors
        id: typecheck_strict
        run: |
          npx tsc --noEmit --strict --allowJs false 2>&1 | tee typecheck-strict-output.txt || true

          # Count TypeScript strict mode errors
          TS_STRICT_ERRORS=$(grep -c "error TS" typecheck-strict-output.txt 2>/dev/null || echo 0)

          echo "total=$TS_STRICT_ERRORS" >> $GITHUB_OUTPUT
          echo "üìä TypeScript Strict Mode Results: ${TS_STRICT_ERRORS} errors"

      - name: Update Issue #748 (Combined Code Quality Tracking)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const eslintTotal = ${{ steps.eslint.outputs.total }};
            const eslintWarnings = ${{ steps.eslint.outputs.warnings }};
            const eslintErrors = ${{ steps.eslint.outputs.errors }};
            const tsTotal = ${{ steps.typecheck.outputs.total }};
            const tsStrictTotal = ${{ steps.typecheck_strict.outputs.total }};
            const currentDate = new Date().toISOString().split('T')[0];

            try {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 748
              });

              // Update the status table with all metrics
              const statusTable = '| **ESLint Total Violations** | **' + eslintTotal + '** | ' + (eslintTotal === 0 ? '‚úÖ' : '‚ö†Ô∏è') + ' |\n' +
                '| **ESLint Errors** | ' + eslintErrors + ' | ' + (eslintErrors === 0 ? '‚úÖ' : '‚ùå') + ' |\n' +
                '| **ESLint Warnings** | ' + eslintWarnings + ' | ' + (eslintWarnings === 0 ? '‚úÖ' : '‚ö†Ô∏è') + ' |\n' +
                '| **TypeScript Errors (Non-Strict)** | **' + tsTotal + '** | ' + (tsTotal === 0 ? '‚úÖ' : '‚ùå') + ' |\n' +
                '| **TypeScript Errors (Strict Mode)** | ' + tsStrictTotal + ' | ' + (tsStrictTotal === 0 ? '‚úÖ' : '‚è≥') + ' |\n' +
                '| **Last Updated** | ' + currentDate + ' | - |';

              // Update the status table in the body
              let newBody = issue.data.body.replace(
                /\| \*\*ESLint Total Violations\*\* \| \*\*\d+\*\* \| .* \|\n\| \*\*ESLint Errors\*\* \| \d+ \| .* \|\n\| \*\*ESLint Warnings\*\* \| \d+ \| .* \|\n\| \*\*TypeScript Errors \(Non-Strict\)\*\* \| \*\*\d+\*\* \| .* \|\n\| \*\*TypeScript Errors \(Strict Mode\)\*\* \| \d+ \| .* \|\n\| \*\*Last Updated\*\* \| [^|]+ \| - \|/,
                statusTable
              );

              // Fallback: if the regex doesn't match, try to find and replace just the table section
              if (newBody === issue.data.body) {
                // Try matching the old format and update it
                newBody = issue.data.body.replace(
                  /\| \*\*Total Violations\*\* \| \*\*\d+\*\* \| .* \|\n\| \*\*Errors\*\* \| \d+ \| .* \|\n\| \*\*Warnings\*\* \| \d+ \| .* \|\n\| \*\*Last Updated\*\* \| [^|]+ \| - \|/,
                  statusTable
                );
              }

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 748,
                body: newBody
              });

              console.log('‚úÖ Successfully updated Issue #748 (Combined Code Quality Tracking)');

              // Post comment if there are any issues
              if (eslintTotal > 0 || tsTotal > 0 || tsStrictTotal > 0) {
                const hasIssues = eslintTotal > 0 || tsTotal > 0;
                const statusEmoji = hasIssues ? '‚ö†Ô∏è' : 'üìã';
                const statusText = hasIssues ? 'Code quality issues detected' : 'Strict mode tracking';
                
                const commentBody = `## ${statusEmoji} Code Quality Status - ${currentDate}\n\n` +
                  `**Status**: ${statusText}\n\n` +
                  `### ESLint\n` +
                  `- **Total Issues**: ${eslintTotal}\n` +
                  `  - Errors: ${eslintErrors}\n` +
                  `  - Warnings: ${eslintWarnings}\n\n` +
                  `### TypeScript\n` +
                  `| Mode | Errors | Status |\n` +
                  `|------|--------|--------|\n` +
                  `| **Non-Strict** | ${tsTotal} | ${tsTotal === 0 ? '‚úÖ Ready for production' : '‚ùå Blocks release'} |\n` +
                  `| **Strict Mode** | ${tsStrictTotal} | ${tsStrictTotal === 0 ? '‚úÖ Issue #713 complete' : '‚è≥ Issue #713 in progress'} |\n\n` +
                  (hasIssues ? `‚ùå Code quality issues detected - review and fix before release\n\n` : '') +
                  (tsStrictTotal > 0 ? `üìã ${tsStrictTotal} strict mode errors tracked in #713\n\n` : '') +
                  `_Checked: ${currentDate}_`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: 748,
                  body: commentBody
                });
                console.log('‚úÖ Posted issue comment for code quality status');
              }
            } catch (error) {
              console.log('‚ùå Failed to update issue #748:', error.message);
            }

      - name: Create or update summary comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const eslintTotal = ${{ steps.eslint.outputs.total }};
            const tsTotal = ${{ steps.typecheck.outputs.total }};

            let statusEmoji = '‚úÖ';
            let statusText = 'All checks pass';

            if (eslintTotal > 0 || tsTotal > 0) {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'Code quality issues detected';
            }

            const mergeStatus = eslintTotal === 0 && tsTotal === 0 ? '‚úÖ Ready to merge' : '‚ö†Ô∏è Please review and fix issues before merging';
            const commentBody = '## ' + statusEmoji + ' Code Quality Check\n\n' +
              '**ESLint**: ' + eslintTotal + ' issues\n' +
              '**TypeScript**: ' + tsTotal + ' compilation errors\n\n' +
              mergeStatus + '\n\n' +
              '_Last updated: ' + new Date().toLocaleString('en-US', { timeZone: 'UTC' }) + ' UTC_';

            try {
              // Find existing comment from this bot
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Code Quality Check')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
                console.log('‚úÖ Updated existing code quality comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('‚úÖ Created new code quality comment');
              }
            } catch (error) {
              console.log('‚ùå Could not create/update PR comment:', error.message);
            }
