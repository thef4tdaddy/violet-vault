name: Code Quality Tracker

# Unified workflow to track both ESLint and TypeScript compilation issues
on:
  # Daily tracking at 9 AM UTC
  schedule:
    - cron: "0 9 * * *" # Daily at 9 AM UTC

  # Keep PR checks for validation
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "scripts/**"
      - "*.js"
      - "*.jsx"
      - "*.ts"
      - "*.tsx"

  # Manual trigger option
  workflow_dispatch:

# Prevent duplicate runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  track-code-quality:
    runs-on: ubuntu-latest
    name: Track ESLint and TypeScript Issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'schedule' && 'develop' || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint and capture warnings
        id: eslint
        run: |
          npx eslint --config configs/linting/eslint.config.js . --ext .js,.jsx,.ts,.tsx --format json > eslint-output.json 2>/dev/null || true

          # Count warnings
          WARNINGS=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' eslint-output.json 2>/dev/null || echo 0)
          ERRORS=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' eslint-output.json 2>/dev/null || echo 0)
          TOTAL=$((WARNINGS + ERRORS))

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

          echo "üìä ESLint Results: ${TOTAL} issues (${WARNINGS} warnings, ${ERRORS} errors)"

      - name: Run TypeScript compiler and capture errors
        id: typecheck
        run: |
          npm run typecheck 2>&1 | tee typecheck-output.txt || true

          # Count TypeScript errors
          TS_ERRORS=$(grep -c "error TS" typecheck-output.txt 2>/dev/null || echo 0)

          echo "total=$TS_ERRORS" >> $GITHUB_OUTPUT
          echo "üìä TypeScript Results: ${TS_ERRORS} compilation errors"

      - name: Run TypeScript strict mode check and capture errors
        id: typecheck_strict
        run: |
          npx tsc --noEmit --strict --allowJs false 2>&1 | tee typecheck-strict-output.txt || true

          # Count TypeScript strict mode errors
          TS_STRICT_ERRORS=$(grep -c "error TS" typecheck-strict-output.txt 2>/dev/null || echo 0)

          echo "total=$TS_STRICT_ERRORS" >> $GITHUB_OUTPUT
          echo "üìä TypeScript Strict Mode Results: ${TS_STRICT_ERRORS} errors"

      - name: Update Issue #748 (ESLint Tracking)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const eslintTotal = ${{ steps.eslint.outputs.total }};
            const eslintWarnings = ${{ steps.eslint.outputs.warnings }};
            const eslintErrors = ${{ steps.eslint.outputs.errors }};
            const currentDate = new Date().toISOString().split('T')[0];

            // Update issue body with latest metrics
            const bodyUpdate = '| **Total Violations** | **' + eslintTotal + '** | ' + (eslintTotal === 0 ? '‚úÖ' : '‚ö†Ô∏è') + ' |\n' +
              '| **Errors** | ' + eslintErrors + ' | ' + (eslintErrors === 0 ? '‚úÖ' : '‚ùå') + ' |\n' +
              '| **Warnings** | ' + eslintWarnings + ' | ' + (eslintWarnings === 0 ? '‚úÖ' : '‚ö†Ô∏è') + ' |\n' +
              '| **Last Updated** | ' + currentDate + ' | - |';

            try {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 748
              });

              // Update the body with new metrics in the status table
              let newBody = issue.data.body.replace(
                /\| \*\*Total Violations\*\* \| \*\*\d+\*\* \| .* \|\n\| \*\*Errors\*\* \| \d+ \| .* \|\n\| \*\*Warnings\*\* \| \d+ \| .* \|\n\| \*\*Last Updated\*\* \| [^|]+ \| - \|/,
                bodyUpdate
              );

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 748,
                body: newBody
              });

              console.log('‚úÖ Successfully updated Issue #748 (ESLint Tracking)');

              // Only post comment if there are violations
              if (eslintTotal > 0) {
                const commentBody = '## ‚ö†Ô∏è ESLint Issues Detected - ' + currentDate + '\n\n' +
                  '**Status**: Issues found\n\n' +
                  '- **Total Issues**: ' + eslintTotal + '\n' +
                  '  - Warnings: ' + eslintWarnings + '\n' +
                  '  - Errors: ' + eslintErrors + '\n\n' +
                  '‚ùå Code quality issues detected - review and fix before release\n\n' +
                  '_Checked: ' + currentDate + '_';

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: 748,
                  body: commentBody
                });
                console.log('‚úÖ Posted issue comment for violations');
              }
            } catch (error) {
              console.log('‚ùå Failed to update issue #748:', error.message);
            }

      - name: Update Issue #806 (TypeScript Tracking)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const tsTotal = ${{ steps.typecheck.outputs.total }};
            const tsStrictTotal = ${{ steps.typecheck_strict.outputs.total }};
            const currentDate = new Date().toISOString().split('T')[0];

            try {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 806
              });

              // Update the "Latest Error Count" line in the body
              let newBody = issue.data.body;
              
              // Update non-strict mode count
              newBody = newBody.replace(
                /\*\*Latest Error Count\*\*: \d+.*$/m,
                `**Latest Error Count**: ${tsTotal} remaining (non-strict) | ${tsStrictTotal} with strict mode`
              );

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 806,
                body: newBody
              });

              console.log('‚úÖ Updated Issue #806 body with current counts');

              // Post comment with details
              const statusEmoji = tsTotal === 0 ? '‚úÖ' : 'üî¥';
              const statusText = tsTotal === 0 ? 'All TypeScript errors resolved!' : 'Compilation errors found';
              
              const commentBody = `## ${statusEmoji} TypeScript Status - ${currentDate}\n\n` +
                `**Status**: ${statusText}\n\n` +
                `| Mode | Errors | Status |\n` +
                `|------|--------|--------|\n` +
                `| **Non-Strict** | ${tsTotal} | ${tsTotal === 0 ? '‚úÖ Ready for production' : '‚ùå Blocks release'} |\n` +
                `| **Strict Mode** | ${tsStrictTotal} | ${tsStrictTotal === 0 ? '‚úÖ Issue #713 complete' : '‚è≥ Issue #713 in progress'} |\n\n` +
                (tsTotal === 0 ? `üéâ **Non-strict mode is clean!** Ready for production.\n\n` : `‚ùå ${tsTotal} compilation errors - blocks v2.0 release\n\n`) +
                (tsStrictTotal > 0 ? `üìã ${tsStrictTotal} strict mode errors tracked in #713\n\n` : '') +
                `_Checked: ${currentDate}_`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 806,
                body: commentBody
              });

              console.log('‚úÖ Posted status comment on issue #806');
            } catch (error) {
              console.log('‚ùå Failed to update issue #806:', error.message);
            }

      - name: Create or update summary comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const eslintTotal = ${{ steps.eslint.outputs.total }};
            const tsTotal = ${{ steps.typecheck.outputs.total }};

            let statusEmoji = '‚úÖ';
            let statusText = 'All checks pass';

            if (eslintTotal > 0 || tsTotal > 0) {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'Code quality issues detected';
            }

            const mergeStatus = eslintTotal === 0 && tsTotal === 0 ? '‚úÖ Ready to merge' : '‚ö†Ô∏è Please review and fix issues before merging';
            const commentBody = '## ' + statusEmoji + ' Code Quality Check\n\n' +
              '**ESLint**: ' + eslintTotal + ' issues\n' +
              '**TypeScript**: ' + tsTotal + ' compilation errors\n\n' +
              mergeStatus + '\n\n' +
              '_Last updated: ' + new Date().toLocaleString('en-US', { timeZone: 'UTC' }) + ' UTC_';

            try {
              // Find existing comment from this bot
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Code Quality Check')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
                console.log('‚úÖ Updated existing code quality comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('‚úÖ Created new code quality comment');
              }
            } catch (error) {
              console.log('‚ùå Could not create/update PR comment:', error.message);
            }
