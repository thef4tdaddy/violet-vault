name: Lint Warnings Tracker

on:
  # Daily tracking for active development monitoring
  schedule:
    - cron: "0 9 * * *" # Daily at 9 AM UTC

  # Keep PR checks for validation
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "scripts/**"
      - "*.js"
      - "*.jsx"
      - "*.ts"
      - "*.tsx"

  # Manual trigger option
  workflow_dispatch:

jobs:
  lint-warnings:
    runs-on: ubuntu-latest
    name: Track Lint Warnings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint and capture warnings
        id: lint
        run: |
          # Run ESLint and capture both stdout and stderr
          npm run lint --silent > eslint-output.txt 2>&1 || true

          # Parse the output to extract warnings
          node scripts/parse-eslint-warnings.js eslint-output.txt > new-warnings.json

          # Get current warning count from existing file
          CURRENT_COUNT=$(if [ -f "./.github/data/lint-warnings.json" ]; then 
            cat .github/data/lint-warnings.json | jq -r '.currentStatus.totalWarnings // 0'
          else 
            echo 0
          fi)

          # Get new warning count
          NEW_COUNT=$(if [ -f "./new-warnings.json" ]; then 
            cat new-warnings.json | jq -r '.currentStatus.totalWarnings // 0'
          else 
            echo 0
          fi)

          echo "current_count=$CURRENT_COUNT" >> $GITHUB_OUTPUT
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

          # Calculate percentage increase
          PERCENTAGE_INCREASE=$(node -e "
            const current = $CURRENT_COUNT;
            const newCount = $NEW_COUNT;
            if (current === 0) {
              console.log(newCount > 0 ? 100 : 0);
            } else {
              const increase = ((newCount - current) / current) * 100;
              console.log(Math.round(increase * 100) / 100);
            }
          ")

          echo "percentage_increase=$PERCENTAGE_INCREASE" >> $GITHUB_OUTPUT

      - name: Check warning increase threshold
        id: check_threshold
        run: |
          PERCENTAGE_INCREASE="${{ steps.lint.outputs.percentage_increase }}"
          CURRENT_COUNT="${{ steps.lint.outputs.current_count }}"
          NEW_COUNT="${{ steps.lint.outputs.new_count }}"

          echo "ğŸ“Š **Lint Warning Analysis**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous warnings:** $CURRENT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Current warnings:** $NEW_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Change:** $PERCENTAGE_INCREASE%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if increase is over 20%
          if (( $(echo "$PERCENTAGE_INCREASE > 20" | bc -l) )); then
            echo "âŒ **FAILED:** Warning count increased by $PERCENTAGE_INCREASE% (over 20% threshold)" >> $GITHUB_STEP_SUMMARY
            echo "threshold_exceeded=true" >> $GITHUB_OUTPUT
            exit 1
          elif (( $(echo "$PERCENTAGE_INCREASE > 0" | bc -l) )); then
            echo "âš ï¸ **WARNING:** Warning count increased by $PERCENTAGE_INCREASE% (within 20% threshold)" >> $GITHUB_STEP_SUMMARY
            echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
          elif (( $(echo "$PERCENTAGE_INCREASE < 0" | bc -l) )); then
            echo "âœ… **IMPROVED:** Warning count decreased by $(echo "$PERCENTAGE_INCREASE * -1" | bc -l)%" >> $GITHUB_STEP_SUMMARY
            echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… **STABLE:** No change in warning count" >> $GITHUB_STEP_SUMMARY
            echo "threshold_exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: Update lint-warnings.json on main/develop push
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          # Replace the existing lint-warnings.json with the new data
          cp new-warnings.json .github/data/lint-warnings.json

          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if there are changes
          if git diff --quiet .github/data/lint-warnings.json; then
            echo "No changes to lint-warnings.json"
          else
            git add .github/data/lint-warnings.json
            git commit -m "chore: update lint warnings tracking data [skip ci]
            
            Updated by GitHub Action after lint analysis
            
            ğŸ¤– Generated with GitHub Actions"
            git push
          fi

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const currentCount = '${{ steps.lint.outputs.current_count }}';
            const newCount = '${{ steps.lint.outputs.new_count }}';
            const percentageIncrease = '${{ steps.lint.outputs.percentage_increase }}';
            const thresholdExceeded = '${{ steps.check_threshold.outputs.threshold_exceeded }}' === 'true';

            let emoji = 'âœ…';
            let status = 'PASSED';
            let color = 'green';

            if (thresholdExceeded) {
              emoji = 'âŒ';
              status = 'FAILED';
              color = 'red';
            } else if (parseFloat(percentageIncrease) > 0) {
              emoji = 'âš ï¸';
              status = 'WARNING';
              color = 'orange';
            }

            const body = `## ${emoji} Lint Warning Analysis - ${status}

            | Metric | Value |
            |--------|-------|
            | **Previous Warnings** | ${currentCount} |
            | **Current Warnings** | ${newCount} |
            | **Change** | ${percentageIncrease}% |
            | **Threshold** | 20% increase |

            ${thresholdExceeded 
              ? 'ğŸš¨ **This PR exceeds the 20% warning increase threshold and will be blocked.**' 
              : 'âœ… **This PR is within the acceptable warning increase threshold.**'
            }

            <details>
            <summary>View detailed warning breakdown</summary>

            The full warning analysis is available in the workflow summary.
            You can also check the \`.github/data/lint-warnings.json\` file for detailed breakdown by category and file.

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check if should run based on branch and schedule
        id: should_run
        run: |
          # For scheduled runs, check branch-specific frequency
          if [ "${{ github.event_name }}" == "schedule" ]; then
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            DAY_OF_WEEK=$(date +%u) # 1=Monday, 7=Sunday
            
            if [ "$CURRENT_BRANCH" == "main" ]; then
              # Main branch: only run on Sundays (weekly)
              if [ "$DAY_OF_WEEK" == "7" ]; then
                echo "should_run=true" >> $GITHUB_OUTPUT
                echo "ğŸ“… Running weekly check for main branch"
              else
                echo "should_run=false" >> $GITHUB_OUTPUT
                echo "â­ï¸ Skipping daily check for main branch (weekly only)"
              fi
            else
              # Develop and other branches: run daily
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "ğŸ“… Running daily check for $CURRENT_BRANCH branch"
            fi
          else
            # Always run for push events and manual triggers
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Update Master Lint Warnings Issue
        if: steps.should_run.outputs.should_run == 'true' && (github.event_name == 'schedule' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')))
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read current warning data
            let warningData;
            try {
              warningData = JSON.parse(fs.readFileSync('./new-warnings.json', 'utf8'));
            } catch (error) {
              console.log('Could not read warning data, skipping issue update');
              return;
            }
            
            const totalWarnings = warningData.currentStatus?.totalWarnings || 0;
            const unusedVars = warningData.breakdown?.['no-unused-vars'] || 0;
            const reactHooks = warningData.breakdown?.['react-hooks/exhaustive-deps'] || 0;
            const files300Plus = warningData.fileSizeTracking?.files300Plus || 0;
            const files400Plus = warningData.fileSizeTracking?.files400Plus || 0;
            const currentDate = new Date().toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
            
            const issueBody = `# ğŸ“Š Master Lint Warnings Tracking Issue

**This issue tracks the ongoing status of ESLint warnings across the entire codebase and is automatically updated by GitHub Actions.**

---

## ğŸ¯ Current Status
- **Total warnings:** ${totalWarnings}
- **Target goal:** <20 warnings 
- **Progress:** 96 â†’ ${totalWarnings} warnings (${Math.round(((96 - totalWarnings) / 96) * 100)}% reduction ${totalWarnings < 96 ? 'âœ…' : ''})
- **Last updated:** ${currentDate}

## ğŸ“ˆ Warning Breakdown

### By Category
- **Unused Variables (no-unused-vars):** ${unusedVars} warnings ${unusedVars > 30 ? 'ğŸ”´' : unusedVars > 15 ? 'ğŸŸ¡' : 'ğŸŸ¢'}
- **React Hook Dependencies (react-hooks/exhaustive-deps):** ${reactHooks} warnings ${reactHooks > 20 ? 'ğŸ”´' : reactHooks > 10 ? 'ğŸŸ ' : 'ğŸŸ¢'}

### ğŸ“ File Size Tracking (Issue #569)
- **Files 300+ lines (warnings):** ${files300Plus} files ${files300Plus > 20 ? 'ğŸ”´' : files300Plus > 10 ? 'ğŸŸ¡' : 'ğŸŸ¢'}
- **Files 400+ lines (errors):** ${files400Plus} files ${files400Plus > 5 ? 'ğŸ”´' : files400Plus > 0 ? 'ğŸŸ¡' : 'ğŸŸ¢'}
- **Graduated enforcement:** 300+ = warn, 400+ = error, 500+ = critical

### ğŸ“‹ Most Common Warnings
${warningData.warningCategories?.slice(0, 5).map(cat => 
  \`- **\${cat.type}**: \${cat.count} warnings (\${cat.files.length} files)\`
).join('\\n') || 'No warning details available'}

### By Priority
- **ğŸš¨ Critical (Errors):** 0 âœ… (All resolved)
- **ğŸŸ¡ Medium (Code Quality):** ${unusedVars} warnings
- **ğŸŸ  Low (Dependencies):** ${reactHooks} warnings

---

## ğŸ† Recent Achievements

### âœ… **Phase 1 Complete** (September 2025)
- **Fixed 17 no-undef errors** (critical bugs eliminated)
- **Fixed 7 syntax errors** (case-declarations + useless-escape)
- **Eliminated all console violations** (centralized logging)
- **Optimized ESLint configuration** (underscore variable handling)

---

## ğŸ¯ Action Plan

### High Priority Tasks
${warningData.actionPlan?.highPriority?.map(task => 
  \`#### \${task.task} (\${task.warningsAffected} warnings)
**Files:** \${task.files.join(', ')}
**Action:** \${task.action}\`
).join('\\n\\n') || 'No high-priority tasks identified'}

### Medium Priority Tasks  
${warningData.actionPlan?.mediumPriority?.length > 0 ? 
  warningData.actionPlan.mediumPriority.map(task => 
    \`- **\${task.task}**: \${task.warningsAffected} warnings in \${task.files.length} files\`
  ).join('\\n') : '- None currently'}

---

## ğŸ“‹ Next Steps

### ğŸ¯ **Phase 2: Unused Variables (${unusedVars} warnings)**
- [ ] Prefix future feature variables with \`_\`
- [ ] Remove genuinely unused imports
- [ ] Add eslint-disable comments where appropriate

### ğŸ¯ **Phase 3: React Hook Dependencies (${reactHooks} warnings)**
- [ ] Analyze dependency chains for safety
- [ ] Add missing dependencies where appropriate
- [ ] Use eslint-disable with explanations for intentional omissions

---

## ğŸ“Š Historical Progress

| Date | Total | Change | Notes |
|------|-------|--------|-------|
| ${currentDate} | ${totalWarnings} | ${totalWarnings < 96 ? '-' + (96 - totalWarnings) : '+' + (totalWarnings - 96)} | ${totalWarnings < 70 ? 'Good progress' : 'Initial cleanup'} |
| Sep 3, 2025 | 62 | -34 | Major cleanup: eliminated all critical errors |
| *baseline* | 96 | - | Starting point with critical bugs |

---

## ğŸ¤– Automation

This issue is automatically updated by:
- **GitHub Actions workflow:** \`.github/workflows/lint-warnings-tracker.yml\`
- **Update frequency:** Daily on develop branch, Weekly on main branch
- **Data source:** \`.github/data/lint-warnings.json\`
- **File size tracking:** Graduated enforcement with 300/400/500 line limits

The workflow tracks warning trends and prevents regression by blocking PRs that increase warnings by >20%.

---

## ğŸ“š Additional Resources

- **Detailed tracking:** \`docs/lint_warnings.md\`
- **ESLint configuration:** \`configs/eslint.config.js\`
- **Automated tracking data:** \`.github/data/lint-warnings.json\`

---

*This issue will remain open until we reach the target of <20 warnings total.*`;

            // Update the master issue (Issue #568)
            try {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 568,
                body: issueBody
              });
              
              console.log('âœ… Successfully updated Master Lint Warnings Issue #568');
            } catch (error) {
              console.log('âŒ Failed to update issue #568:', error.message);
            }
