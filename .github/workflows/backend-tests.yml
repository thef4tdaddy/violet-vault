name: Backend API Tests

on:
  push:
    branches: [main, develop, 'milestone-*', 'copilot/**']
    paths:
      - 'api/**'
      - 'go.mod'
      - 'pyproject.toml'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'api/**'
      - 'go.mod'
      - 'pyproject.toml'
      - '.github/workflows/backend-tests.yml'

jobs:
  go-tests:
    name: Go Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Run Go tests
        run: |
          cd api
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage
        run: |
          cd api
          go tool cover -func=coverage.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./api/coverage.out
          flags: go-backend
          name: go-backend-coverage

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest pytest-cov

      - name: Run ruff linter
        run: |
          ruff check api/ --output-format=github

      - name: Run ruff formatter check
        run: |
          ruff format api/ --check

      - name: Run mypy type checker
        run: |
          mypy api/analytics.py --ignore-missing-imports
        continue-on-error: true

      - name: Run Python tests
        run: |
          cd api/tests
          python -m pytest test_analytics.py -v --tb=short

      - name: Run Python tests with coverage
        run: |
          cd api/tests
          python -m pytest test_analytics.py --cov=../analytics --cov-report=xml --cov-report=term
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./api/tests/coverage.xml
          flags: python-backend
          name: python-backend-coverage
        continue-on-error: true

  go-lint:
    name: Go Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: api
          args: --timeout=5m
        continue-on-error: true

  integration-check:
    name: Integration Check
    runs-on: ubuntu-latest
    needs: [go-tests, python-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify API structure
        run: |
          echo "Checking API structure..."
          test -f api/bug-report.go || { echo "Missing api/bug-report.go"; exit 1; }
          test -f api/analytics.py || { echo "Missing api/analytics.py"; exit 1; }
          test -f go.mod || { echo "Missing go.mod"; exit 1; }
          test -f pyproject.toml || { echo "Missing pyproject.toml"; exit 1; }
          echo "âœ… API structure verified"

      - name: Check Vercel configuration
        run: |
          echo "Checking Vercel configuration..."
          test -f vercel.json || { echo "Missing vercel.json"; exit 1; }
          grep -q "bug-report.go" vercel.json || { echo "Bug report function not configured in vercel.json"; exit 1; }
          grep -q "analytics.py" vercel.json || { echo "Analytics function not configured in vercel.json"; exit 1; }
          echo "âœ… Vercel configuration verified"

      - name: Success
        run: |
          echo "ðŸŽ‰ All backend tests passed successfully!"
